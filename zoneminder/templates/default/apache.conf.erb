<VirtualHost *:80>
  ServerAdmin <%= @node[:apache][:contact] %>
  ServerName <%= @params[:server_name] %>
  ServerAlias <%= @params[:server_aliases].join(' ') %>

  CustomLog <%= @params[:log_dir] %>/access.log combined
  LogLevel warn
  ErrorLog  <%= @params[:log_dir] %>/error.log
  RewriteLog <%= @params[:log_dir] %>/rewrite.log

  RewriteEngine on
#  RewriteLogLevel 8

<IfModule !mod_ssl.c>
  RewriteCond %{HTTP_HOST} !<%= @params[:server_name] %>
  RewriteRule ^/(.*)   https://<%= @params[:server_name] %>/$1/ [R,L]

  RewriteCond %{HTTP_HOST} !<%= @params[:server_name] %>
  RewriteRule ^/(.*)   http://<%= @params[:server_name] %>/$1/ [R,L]

  RewriteRule ^/$  /zm/ [R,L]

  Include /etc/zm/apache.conf

  ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
  <Directory "/usr/lib/cgi-bin">
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    Order allow,deny
    Allow from all
  </Directory>

</IfModule>  
<IfModule mod_ssl.c>
  RewriteRule ^(/.*)  https://%{SERVER_NAME}$1 [R,L]
</IfModule>
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
  ServerAdmin <%= @node[:apache][:contact] %>
  ServerName <%= @params[:server_name] %>
  ServerAlias <%= @params[:server_aliases].join(' ') %>

  CustomLog <%= @params[:log_dir] %>/access-ssl.log combined
  LogLevel warn
  ErrorLog  <%= @params[:log_dir] %>/error-ssl.log
  RewriteLog <%= @params[:log_dir] %>/rewrite-ssl.log

  SSLEngine On
  SSLCertificateKeyFile <%= @params[:ssl_cert_file] %>
  SSLCertificateFile    <%= @params[:ssl_cert_file] %>

  RewriteEngine on
#  RewriteLogLevel 8

  RewriteCond %{HTTP_HOST} !<%= @params[:server_name] %>
  RewriteRule ^/(.*)   https://<%= @params[:server_name] %>/$1/ [R,L]

  RewriteRule ^/$  /zm/ [R,L]

  Include /etc/zm/apache.conf

  ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
  <Directory "/usr/lib/cgi-bin">
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    Order allow,deny
    Allow from all
  </Directory>

</VirtualHost>
</IfModule> 
